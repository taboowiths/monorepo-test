name: Deploy to Production

on:
  push:
    branches:
      - main

permissions:
  contents: write

concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Build packages
        run: |
          echo "ðŸ”¨ Building packages..."
          pnpm --filter './packages/*' build

      - name: Build Project A
        run: |
          echo "ðŸ—ï¸ Building Project A..."
          pnpm --filter @test/project-a build

      - name: Build Project B
        run: |
          echo "ðŸ—ï¸ Building Project B..."
          pnpm --filter @test/project-b build

      - name: Deploy Project A
        run: |
          echo "ðŸš€ [SIMULATION] Deploying Project A to PRODUCTION..."
          VERSION=$(cat apps/project-a/package.json | grep '"version"' | head -1 | awk -F: '{ print $2 }' | sed 's/[", ]//g')
          echo "   URL: https://project-a.example.com"
          echo "   Version: $VERSION"
          echo "âœ… Project A deployed"

      - name: Deploy Project B
        run: |
          echo "ðŸš€ [SIMULATION] Deploying Project B to PRODUCTION..."
          VERSION=$(cat apps/project-b/package.json | grep '"version"' | head -1 | awk -F: '{ print $2 }' | sed 's/[", ]//g')
          echo "   URL: https://project-b.example.com"
          echo "   Version: $VERSION"
          echo "âœ… Project B deployed"

      - name: Create Release Tag
        run: |
          # react-hooks ë²„ì „ì„ ê¸°ì¤€ìœ¼ë¡œ íƒœê·¸ ìƒì„± (ë” ì •í™•í•¨)
          VERSION=$(cat package.json | grep '"version"' | head -1 | awk -F: '{ print $2 }' | sed 's/[", ]//g')

          echo "ðŸ“¦ Monorepo version: $VERSION"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # íƒœê·¸ê°€ ì´ë¯¸ ì¡´ìž¬í•˜ëŠ”ì§€ í™•ì¸
          if git rev-parse "v$VERSION" >/dev/null 2>&1; then
            echo "â­ï¸  Tag v$VERSION already exists"
          else
            git tag -a "v$VERSION" -m "Release v$VERSION"
            git push origin "v$VERSION"
            echo "âœ… Created tag v$VERSION"
          fi

      - name: Summary
        if: always()
        run: |
          echo "## ðŸš€ Production Deployment Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          VERSION=$(cat packages/react-hooks/package.json | grep '"version"' | head -1 | awk -F: '{ print $2 }' | sed 's/[", ]//g')
          echo "### Version: v$VERSION" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Project A: https://project-a.example.com" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Project B: https://project-b.example.com" >> $GITHUB_STEP_SUMMARY