name: Deploy to Development

on:
  push:
    branches:
      - develop

concurrency:
  group: deploy-develop
  cancel-in-progress: true

jobs:
  version-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Create snapshot version
        run: |
          SNAPSHOT_TAG="dev-$(date +%Y%m%d)-$(git rev-parse --short HEAD)"
          echo "ðŸ“¦ Creating snapshot version: $SNAPSHOT_TAG"
          pnpm changeset version --snapshot $SNAPSHOT_TAG

      - name: Show version changes
        run: |
          echo "Version changes:"
          git diff --name-only | grep package.json || echo "No package.json changes"

      - name: Build packages
        run: |
          echo "ðŸ”¨ Building packages..."
          pnpm --filter './packages/*' build || echo "No build script in packages"

      - name: Detect affected apps
        id: affected
        run: |
          echo "ðŸ” Detecting affected apps..."

          # ë³€ê²½ëœ íŒŒì¼ í™•ì¸
          CHANGED_FILES=$(git diff --name-only HEAD~1 2>/dev/null || echo "")
          echo "Changed files: $CHANGED_FILES"

          # project-a ì˜í–¥ í™•ì¸
          if echo "$CHANGED_FILES" | grep -q "apps/project-a\|packages/react-hooks\|packages/ui"; then
            echo "PROJECT_A_AFFECTED=true" >> $GITHUB_OUTPUT
            echo "âœ… Project A is affected"
          else
            echo "PROJECT_A_AFFECTED=false" >> $GITHUB_OUTPUT
            echo "â­ï¸  Project A is NOT affected"
          fi

          # project-b ì˜í–¥ í™•ì¸
          if echo "$CHANGED_FILES" | grep -q "apps/project-b\|packages/react-hooks\|packages/ui"; then
            echo "PROJECT_B_AFFECTED=true" >> $GITHUB_OUTPUT
            echo "âœ… Project B is affected"
          else
            echo "PROJECT_B_AFFECTED=false" >> $GITHUB_OUTPUT
            echo "â­ï¸  Project B is NOT affected"
          fi

      - name: Build Project A
        if: steps.affected.outputs.PROJECT_A_AFFECTED == 'true'
        run: |
          echo "ðŸ—ï¸  Building Project A for DEV environment..."
          pnpm --filter @test/project-a build
          echo "âœ… Project A build completed"

      - name: Build Project B
        if: steps.affected.outputs.PROJECT_B_AFFECTED == 'true'
        run: |
          echo "ðŸ—ï¸  Building Project B for DEV environment..."
          pnpm --filter @test/project-b build
          echo "âœ… Project B build completed"

      - name: Simulate Deploy Project A
        if: steps.affected.outputs.PROJECT_A_AFFECTED == 'true'
        run: |
          echo "ðŸš€ [SIMULATION] Deploying Project A to DEV..."
          echo "   Environment: Development"
          echo "   URL: https://dev-project-a.example.com"
          echo "   Build output: apps/project-a/dist"
          ls -la apps/project-a/dist || echo "No dist folder"
          echo "âœ… Project A deployment simulated"

      - name: Simulate Deploy Project B
        if: steps.affected.outputs.PROJECT_B_AFFECTED == 'true'
        run: |
          echo "ðŸš€ [SIMULATION] Deploying Project B to DEV..."
          echo "   Environment: Development"
          echo "   URL: https://dev-project-b.example.com"
          echo "   Build output: apps/project-b/dist"
          ls -la apps/project-b/dist || echo "No dist folder"
          echo "âœ… Project B deployment simulated"

      - name: Summary
        if: always()
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Affected Projects" >> $GITHUB_STEP_SUMMARY
          echo "- Project A: ${{ steps.affected.outputs.PROJECT_A_AFFECTED }}" >> $GITHUB_STEP_SUMMARY
          echo "- Project B: ${{ steps.affected.outputs.PROJECT_B_AFFECTED }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Environment" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: develop" >> $GITHUB_STEP_SUMMARY
          echo "- Target: Development" >> $GITHUB_STEP_SUMMARY
